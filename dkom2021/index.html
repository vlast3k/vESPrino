<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
    <!-- <link href="http://localhost:8080/dkom.css" rel="stylesheet" /> -->
    <!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
    <!-- <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script> -->
    <title>d-kom 2021 Sofia</title>
    <style>
        .nav-pills .nav-link.active {
          background-color: rgb(255, 200, 61);
          color: rgb(27, 26, 25);
        }
        .nav-pills .nav-link {
          color: whitesmoke;
        }
        .slidecontainer {
  width: 100%; /* Width of the outside container */
}

/* The slider itself */
.slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  width: 100%; /* Full-width */
  height: 25px; /* Specified height */
  background: #d3d3d3; /* Grey background */
  outline: none; /* Remove outline */
  opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  background: #4CAF50; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb {
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  background: #4CAF50; /* Green background */
  cursor: pointer; /* Cursor on hover */
}     
.popover{
    max-width: 100%; /* Max Width of the popover (depending on the container!) */
}   
      </style>
  </head>
  
  <body style="background-color: #222222;">
    <div id="divtest"> </div> 
    <div id="browser" style="color:white;display: block;"> </div> 
    <ul class="nav nav-pills mb-2" id="pills-tab" role="tablist"></ul>
    <div class="tab-content" id="pills-tabContent"></div>      
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <script src="https://sap.sharepoint.com/sites/124250/Shared%20Documents/dkom2021/contentSubmissions.js?1000"></script> 
    <script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script>
$(document).ready(function(){      
      var ZOOM="https://sap.sharepoint.com/sites/124250/Shared%20Documents/dkom2021/zoom_logo.png";
      var ZIMA ="https://sap.sharepoint.com/sites/124250/Shared%20Documents/zimacap.PNG"
      var TEAMS="https://sap.sharepoint.com/sites/124250/Shared%20Documents/dkom2021/teams_logo.png";
      var VID1="https://sap.sharepoint.com/sites/124250/Shared%20Documents/dkom2021/1min.mp4";
      var VID2="https://sap.sharepoint.com/sites/124250/Shared%20Documents/dkom2021/keynote1.mp4";
      var Tracks = [{id:"Keynote"},{id:"Jupiter"},{id:"Earth"},{id:"Mars"},{id:"Saturn"},{id:"Venus"},{id:"Neptune"}] ;
      //var Tracks = [{id:"Saturn"}] ;
      //Tracks = [] ;
      $("#ct").show();
      $("#browser").text("is safari: " + window.safari + ", vendor: " + navigator.vendor)
      if (navigator.vendor.indexOf("Apple") > -1) {
        alert("For Mac and iPhone, please use Chrome or Firefox browser, to load the Agenda correctly")
      }
    
      var cfg = JSON.parse(atob(res)).map(x => {return {
        title: x.Title,
        abstract: x.Abstract,
        contentType: x.ContentType0 && x.ContentType0.Value,
        duration: x.Duration_x0028_min_x0029_ && x.Duration_x0028_min_x0029_.Value*60,
        presenters:[ x.Presenter1 && x.Presenter1.DisplayName || x.Presenter1_ext,
        x.Presenter2 && x.Presenter2.DisplayName || x.Presenter2_Ext,
        x.Presenter3 && x.Presenter3.DisplayName,
        x.Presenter4 && x.Presenter4.DisplayName,
        x.Presenter5 && x.Presenter5.DisplayName],
        start: new Date(x.Start),
        liveUrl: x.ConnectionURL,
        recordingUrl: x.Recording,
        track: x.Track && x.Track.Value,
        warmup: 5*60*1000
      }});
      var currentSession = {};
      var intervalTimers = {};
      var currentTimeMillis = null;//Date.now();
      var timeStarted = Date.now();//Date.now();
      if (window.location.href.indexOf("test") > 1) {
          currentTimeMillis = Date.now() + 1*1000;
          startTimeTimer(1);
          $("#divtest").html(`  
            <div id="ct" style="color:white;display:block"></div>
            <div class="slidecontainer">
              <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
            </div>`);
            var slider = document.getElementById("myRange");
            var output = document.getElementById("demo");
            slider.setAttribute("min", new Date("Thu Mar 25 2021 09:00:43 GMT+0200").getTime());
            slider.setAttribute("max", new Date("Thu Mar 25 2021 18:00:43 GMT+0200").getTime());
            slider.oninput = function() {
              //$("#ct").text(new Date(getCurrentTime()));
              setCurrentTime(Number.parseInt(this.value));
              $("#ct").text(new Date(getCurrentTime()));
              //console.log(this.value + " " + new Date(Number.parseInt(this.value)));
            }      
      }


//$div.addClass('red');      
      function addTestTrack() {
        function addTestSession(title, durationInSec, startInSec, warmupSec, vid) {
          cfg.push({title:title, duration:durationInSec, start:new Date(Date.now() + startInSec*1000),
            //recordingUrl:vid,
            liveUrl:vid,
                    track:"Test", warmup :warmupSec*1000});

        }
        addTestSession("t1", 5, 10, 5, VID1);      
        addTestSession("t2", 15, 30, 0, VID1);
        addTestSession("t3", 25, 60, 5, VID1);
        addTestSession("t4", 35, 90, 10, VID1);
        addTestSession("t5", 10, 120, 5, VID1);
        addTestSession("t6", 15, 150, 0, VID1);
        Tracks.push({id:"Test"});
      }
      //addTestTrack();
      console.log("res is: " + cfg.length);
   
  
      function createPills(ids) {
        function generatePillTab(id, isActive) {
          return `<li class='nav-item track-${id}' id="pills-${id}-li" role='presentation'>
                    <button class='nav-link ${isActive?"active":""}' id='pills-${id}-tab' data-bs-toggle='pill' data-bs-target='#pills-${id}' type='button' role='tab' aria-controls='pills-${id}' aria-selected='true'>${id}</button>
                  </li>\n`;
        }
        function generatePillContent(id, isActive) {
          return `<div class="track-${id} tab-pane fade ${isActive?"show active":""}" id="pills-${id}" role="tabpanel" aria-labelledby="pills-${id}-tab">
                <h5 style="color:white" >Title: <span class="title"></span> <span class="forpop" data-track="${id}" style="color:orange">Info</span> </h5>
                <video class="video-js"  id="${id}"  muted controls  height="320" preload="auto" data-setup="{}" ></video>
                <div class="live-${id}"></div>
          </div>\n`;
        
        }
        ids.forEach(id => {
          document.getElementById('pills-tab').innerHTML += generatePillTab(id.id, id===ids[0]);
          document.getElementById('pills-tabContent').innerHTML += generatePillContent(id.id, id===ids[0]);
        });
      }
  
      function setCurrentTime(value) {
        currentTimeMillis = value;
      }
  
      function getCurrentTime() {
        return currentTimeMillis ||  Date.now() ;
      }

      var fastSpeedInterval;
      function startTimeTimer(speed) {
        var speed = speed || 1;
        clearInterval(fastSpeedInterval);
        fastSpeedInterval = setInterval(() => {currentTimeMillis += speed * 1000}, 1000);
      }
  
      // function fillGaps(track) {
      //   var sorted = getSessionsInTrack(track);
      //   var timers = [];
      //   for (var i=0; i < sorted.length-1; i++) {
      //     var endTime = sorted[i].start.getTime() + sorted[i].duration*60*1000 - 2000;
      //     if (endTime < sorted[i+1].start.getTime()) {
      //       timers.push({title: "Next: " + sorted[i+1].title,
      //                 track: track,
      //                 start: new Date(endTime),
      //                 duration: (sorted[i+1].start.getTime() - endTime)/(60*1000) + 1,
      //                 recordingUrl: TIMER})
      //     }
      //   }
      //   cfg.push(...timers);
      // }
        // var tracks = {};
        // cfg.forEach(x => tracks[x.track] = true);
        // return Object.keys(tracks).sort();
  
      function getSessionsInTrack(track) {
        return cfg.filter(x => x.track === track)
                  .sort((x,y) => x.start.getTime() - y.start.getTime());
      }
  
      function findCurrentSession(track) {
        var sorted = getSessionsInTrack(track);
        var i = 0;
        for (; i < sorted.length && sorted[i].start.getTime() <= getCurrentTime(); i++);  
        //console.log("current session: "+ track + " : " + i);  
        return {current: i > 0 &&  sorted[i-1].start.getTime() + sorted[i-1].duration*1000  > getCurrentTime() ? sorted[i-1] : null, 
                   next: i < sorted.length && getCurrentTime() > sorted[i].start.getTime() - sorted[i].warmup ? sorted[i]  : null};
      }
  
      function onVJSReady() {
        this.on('play', function ()  {
            console.log(this.id());
            var real = currentSession[this.id()];
            if (!real) return;
            var t = (getCurrentTime() - real.start.getTime() + real.warmup)/1000;
            console.log(t)
            this.currentTime(t);
          });
        this.on('loadedmetadata', () => {setSession(this.id())});
      }
  
      function show(id) {
        document.getElementById(id).style.display="block";
      }
  
      function hide(id) {
        document.getElementById(id).style.display="none";
      }

      function hasEnded(s) {
        if (!videojs.players[s.track]) return false;
        var vidDur = videojs.players[s.track].duration() * 1000;
        if (!vidDur) return false;
        var ct = getCurrentTime();
        var startedAt = s.start.getTime() - s.warmup;
        return startedAt + vidDur < ct;
      }

      function setSession(track) {
        var tid    = track.id;
        var tr     = `.track-${tid}`;
        var player = videojs.players[tid];
        if (!player) return; //if player for this track is not yet init, skip this run, it wlll be called again by the Interval
        
        var c      = findCurrentSession(tid);
        if (!(c.current || c.next)) {
          $(`#pills-${tid}-li`).css("display", "none");
          if ($(`#pills-${tid}-tab`).hasClass("active")) {
            $(`#pills-${tid}-tab`).removeClass("active");
            $(`#pills-${tid}`).removeClass("active show");
            //$(`#pills-${tid}`).removeClass("");
          }
          removeIntervalTimer(tid);
          player.pause();
        } else {
          //$(".nav " + tr).css("display", "block");
          $(`#pills-${tid}-li`).css("display", "block");
          $(`#pills-${tid}`).addClass("show");
//          $(`#pills-${tid}`).addClass(  "active");
          //$(".nav-item " + tr).show();
        }

        var switched = false;
        var active = currentSession[tid];
        var currentIsRecordingAndEnded = c.current && c.current.recordingUrl && hasEnded(c.current);
        //console.log(c)
        if (active && (!(c.next || c.current))) {
          currentSession[tid] = null;
          return;
        }
        if (!c.current || currentIsRecordingAndEnded) {
          if (!c.next || (active && active.start == c.next.start)) {
            return; //notging to do: no next, or next already active
          }
          currentSession[tid] = c.next;
          switched = true;
        } else if (active && (active.start == c.current.start || (c.next && active.start == c.next.start))) {
          return; //nothing to do: current is playing (decided by findActiveSession), and not yet ended -- OR next is playing as current is null or ended
        } else { //current is valid AND current is not active
          currentSession[tid] = c.current;
          switched = true;
        }

        if (switched) {
          var real = currentSession[tid];
          console.log("Switching to: " + JSON.stringify(real));
          removeIntervalTimer(tid);
          //$(`#pills-${tid}`).interval && clearInterval($(`#pills-${tid}`).interval);
          if (real.recordingUrl) {
            player.src({type: "video/mp4", src: real.recordingUrl});
            player.play();
            $(tr + " .video-js").show();
            //$(tr + " .link").hide();
            $(".live-" + tid).hide();
            $(tr + " .title").text(real.title);
          } else  {
            player.pause();
            startIntervalTimer(tid);
            $(tr + " .video-js").hide();
            $(".live-" + tid).show();
            $(".live-" + tid).html(`
            <div id="live-details-${tid}" style="color:white" ></div>  
            `);
            //<a target="_blank" href=${real.recordingUrl}><img src=${TEAMS} width="100"/> </a>`
            $(tr + " .link").show();
            $(tr + " .link").attr("href", real.liveUrl);
            $(tr + " .link img").attr("src", real.liveUrl && real.liveUrl.indexOf("teams") > -1 ?  TEAMS : ZOOM);
            updateLiveSession(tid);
          } 
        }
      }
      function startIntervalTimer(tid) {
        intervalTimers[tid] = intervalTimers[tid] || {};
        intervalTimers[tid].id = setInterval(() => {updateLiveSession(tid)}, 1000);
        console.log("added interval: " + intervalTimers[tid].id);

      }
      function removeIntervalTimer(tid) {
        intervalTimers[tid] = intervalTimers[tid] || {};
        if (intervalTimers[tid].id) {
          console.log("removed interval :  " + intervalTimers[tid].id);
          clearInterval(intervalTimers[tid].id);
          intervalTimers[tid].id  = null;
        }
      }


      function updateLiveSession(tid) {
        //console.log("Updating session for " + tid);
        var tr     = `.track-${tid}`;
        var real = currentSession[tid];
        var s = real;
        var diff = real.start.getTime() - getCurrentTime();
        var endtime = new Date(s.start.getTime() + s.duration*1000);
        var rem = "";
        if (diff > 0) {
          rem = "Starts in " + moment(diff).format("mm:ss") + " min"
        } else {
          rem = `${(Math.floor((endtime.getTime() - getCurrentTime())/60/1000))}/${s.duration/60} minutes left`;
        }
        $(tr + " .title").text(real.title);
        $(`#live-details-${tid}`).html(`
<br><a tabindex="0" class="btn btn-lg btn btn-success" role="button" href="${s.liveUrl}">Join Interactive Session</a><br><br>
<b>Time:</b>&nbsp;${moment(s.start).format("hh:mm")} - ${moment(endtime).format("hh:mm")} (${rem})<br>
<b>Presented by:</b>&nbsp;${s.presenters.filter(x=>x).join("; ").trim()}<br>
<b>Abstract:</b>&nbsp;${s.abstract.substring(0,500)}`
        )

            
        // if (diff > 0) {
        //   $(tr + " .title").text("Next Session: " + real.title + " [ in " + diff/60/1000 + " min ]" );
        // } else {
        //   $(tr + " .title").text(real.title);
        // }
      }
  
      function updateSessions() {
        $("#ct").show();
        $("#ct").text(new Date(getCurrentTime()));
        Tracks.forEach(setSession);
        if ($(".nav-item :visible").length > 0 && $(".nav-item .active").length == 0) {
          $(".nav-item :visible")[0].click();
        }
      }
  
      videojs.getComponent('ControlBar').prototype.options_.children = ["playToggle",'fullscreenToggle', "volumePanel"];
      document.addEventListener('contextmenu', event => event.preventDefault());
  
      createPills(Tracks);  
      Tracks.forEach(t => {
       // fillGaps(t.id);
        //hide(`link${t.id}`);
        videojs(`${t.id}`, null, onVJSReady);
      });
   
      setInterval(updateSessions, 1000);
      updateSessions();

      var $div = $(".tab-pane");
var observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.attributeName === "class") {
      var attributeValue = $(mutation.target).prop(mutation.attributeName);
      console.log("Class attribute changed to:", attributeValue);
      //..if (!attributeValue.indexOf("active")) {
        //console("id = " + $(mutation.target).id())
        var v = videojs.players[$(mutation.target).attr("id").split("-")[1]];
        //console.log("Setting : " + v + " to : " + !attributeValue.indexOf("active")); 
        var active = attributeValue.indexOf("active") > -1;
        v.muted(!active);
        //active ? v.play() : v.pause();
      //}
    }
  });
});
for (let i =0; i < $div.length; i++) {
  observer.observe($div[i], {attributes: true});
}
// var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
// var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
//   return new bootstrap.Popover(popoverTriggerEl)
// })

// var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
// var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
//   return new bootstrap.Tooltip(tooltipTriggerEl, {container:'body', trigger: 'hover', placement:"bottom"})
// })

//$("h5").tooltip;({container:'body', trigger: 'hover', placement:"bottom", tite: () => {return "rerrr"}, content: () => {return "fdsfsffff"}});
//$("h5").popover();//{container:'body', trigger: 'hover', placement:"bottom", tite: () => {return "rerrr"}, content: () => {return "fdsfsffff"}});

$('.forpop').each(function(i, obj) {
    $(obj).popover({container:'body', trigger: 'hover', placement:"bottom", html:true,
       // title: () => {return "Details"}, 
        content: () => {
          var s = currentSession[$(obj).data("track")];
          var endtime = new Date(s.start.getTime() + s.duration*1000);
         // console.log(endtime)
          return `
<b>Time:</b>&nbsp;${moment(s.start).format("hh:mm")} - ${moment(endtime).format("hh:mm")} (${(Math.floor((endtime.getTime() - getCurrentTime())/60/1000))}/${s.duration/60} minutes left)<br>
<b>Presented by:</b>&nbsp;${s.presenters.filter(x=>x).join("; ").trim()}<br>
<b>Abstract:</b>&nbsp;${s.abstract}`;}});
});
// $(".forpop").popover({container:'body', trigger: 'hover', placement:"bottom", title: (x) => {
//     console.log(x);
//     return "rerrr"}, content: () => {return "fdsfsffff"}});

// //$("[data-toggle=popover]").popover();
setInterval(()=>{$("[data-popper-reference-hidden]").remove()}, 100);
});
    </script>
    <!-- <script src="https://sap.sharepoint.com/sites/124250/Shared%20Documents/dkom2021/config.js?123"></script>  -->
   
  </body>
