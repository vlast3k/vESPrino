<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
  <!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
  <!-- <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script> -->
  <title>d-kom 2021 Sofia</title>
</head>

<body style="background-color: #222222;">
  <div class="container">
    <div class="row">
      <div class="col">
        <video class="video-js" id="vid1"  muted  controls  width="400" preload="auto" data-setup="{}" ></video>
        <a target="_blank" id="link1" > </a>
      </div>
      <div class="col">
        <video class="video-js"  id="vid2"  muted controls  width="400" preload="auto" data-setup="{}" ></video>
        <a target="_blank"  id="link2" > </a>
      </div>
    </div>
  </div>


  <script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>
  <script>
    const zp = (num, places) => String(num).padStart(places, '0')
    var config = generateTrack("vid1").concat(generateTrack("vid2"));
    var config2 = [
    { track: "vid1", start:"2021,1,11,6,0,0", src: "http://localhost:8080/1min.mp4",
        type: "video"},
        { track: "vid1", start:"2021,1,11,4,0,0", src: "https://8b6677f5-85f0-495d-81db-22121c6c3ce9.s3.eu-central-1.amazonaws.com/12h.mp4",
        type: "video"},
        { track: "vid1", start:"2021,1,11,1,0,0", src: "https://8b6677f5-85f0-495d-81db-22121c6c3ce9.s3.eu-central-1.amazonaws.com/12h.mp4",
        type: "video"},
        { track: "vid1", start:"2021,1,11,8,5,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,8,6,0", src: "http://localhost:8080/1min.mp4", type: "link"},
        { track: "vid1", start:"2021,1,11,8,8,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,40,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,31,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,32,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,33,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,34,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,35,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,7,36,0", src: "http://localhost:8080/1min.mp4", type: "video"},
        { track: "vid1", start:"2021,1,11,9,0,0", src: "https://8b6677f5-85f0-495d-81db-22121c6c3ce9.s3.eu-central-1.amazonaws.com/12h.mp4",
        type: "video"},
        { track: "vid1", start:"2021,1,11,8,0,0", src: "https://8b6677f5-85f0-495d-81db-22121c6c3ce9.s3.eu-central-1.amazonaws.com/12h.mp4",
        type: "video"},
        { track: "vid2", start:"2021,1,11,5,30,0", src: "https://teams.microsoft.com/l/meetup-join/19%3ameeting_MmI0OWM2M2EtYTFkYS00Y2M3LWIyOWMtMzdlMzJjMGI5NGFi%40thread.v2/0?context=%7b%22Tid%22%3a%2242f7676c-f455-423c-82f6-dc2d99791af7%22%2c%22Oid%22%3a%22debc9f8e-dcd6-44ec-a997-3e30ef1cc344%22%7d",
        type: "link"}

      
    ];

    function d2s(d) {return `${d.getFullYear()},${zp(d.getMonth(),2)},${zp(d.getDate(),2)},${zp(d.getHours(),2)},${zp(d.getMinutes(),2)},${zp(d.getSeconds(),2)}`};
    function generateTrack(track) {
      var now = Date.now();
      var c = [];
      for (var i=0; i < 100; i++ ) {
        var d = new Date(now);
        var sd = d2s(d);
        c.push({track:track, start: sd, src:"http://vlast3k.github.io/vESPrino/dkom2021/1min.mp4", type: ((i%2 == 0) ? "video" : "link")});
        now += 10000;
      }
      return c;
    }
    
    function findCurrentSession(track) {
      var d = new Date();
      var sd = d2s(d);
      return  config.filter(x => x.track === track)
                    .sort((x,y) => -x.start.localeCompare(y.start))
                    .find(x => x.start.localeCompare(sd) <= 0);
    }

    function onVJSReady() {
      this.on('play', function ()  {
          var ses = findCurrentSession(this.id());
          var s = ses.start.split(",");
          var d = new Date(s[0], s[1], s[2], s[3], s[4], s[5]);
          var t = (Date.now() - d.getTime())/1000;
          console.log(t)
          this.currentTime((Date.now() - d.getTime())/1000);
        });
    }

    function setSession(track) {
      var active = currentSession[track];
      var real   = findCurrentSession(track);
      var player = videojs.players[track];
      var linkId = track.replace("vid", "link")
      if (!real) {
        console.log("real session not found!");
      }
      if (!active || active.start !== real.start) {
        console.log("Switching........")
        console.log(active);
        console.log(real);
        if (real.type === "video" && player) {
          player.src({type: "video/mp4", src: real.src});
          //if (!player.paused()) 
            player.play();
          currentSession[track] = real;
           document.getElementById(track).style.display="block";
           document.getElementById(linkId).style.display="none";
        } else if (real.type === "link") {
          player && player.pause();
          document.getElementById(track).style.display="none";
          document.getElementById(linkId).style.display="block";
          document.getElementById(linkId).href = real.src;
          document.getElementById(linkId).innerHTML = "link";
          currentSession[track] = real;
        }
        
      }
    }

    // document.getElementById("vid1").style.display="none";
    // document.getElementById("vid2").style.display="none";
    document.getElementById("link1").style.display="none";
    document.getElementById("link2").style.display="none";
    videojs.getComponent('ControlBar').prototype.options_.children = ["playToggle",'fullscreenToggle', "volumePanel"];
    document.addEventListener('contextmenu', event => event.preventDefault());
    var currentSession = {};

    videojs("vid1", null, onVJSReady);
    videojs("vid2", null, onVJSReady);
    setSession("vid1");
    setSession("vid2");
    setInterval(() => {
      setSession("vid1");
      setSession("vid2");
    }, 1000);
    //   videojs("my-video").ready(function ()  {
    //   });
    // }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
</body>
